<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR OBJ Viewer with Controls</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
    </style>
      <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.module.min.js",
                "FBXLoader": "https://cdn.jsdelivr.net/npm/three@0.156.1/examples/jsm/loaders/FBXLoader.js",
                "OrbitControls": "https://cdn.jsdelivr.net/npm/three@0.156.1/examples/jsm/controls/OrbitControls.js",
                "dat.gui": "https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.module.js"
            }
        }
    </script>
</head>
<body>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';
        import { OBJLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/OBJLoader.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';
        import { XRControllerModelFactory } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/XRControllerModelFactory.js';
        import { XRHandModelFactory } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/XRHandModelFactory.js';

        let scene, camera, renderer, controls, object;
        let controller1, controller2;
        let controllerGrip1, controllerGrip2;
        let selectedObject = null;

        function init() {
            // Scene, Camera, Renderer
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            document.body.appendChild(VRButton.createButton(renderer));

            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 1));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);

            // Load OBJ Model
            const loader = new OBJLoader();
            loader.load(
                './Hand/TORRLAB.obj',  // Replace with your OBJ file path
                (loadedObject) => {
                    object = loadedObject;
                    object.scale.set(1, 1, 1);
                    object.position.set(0, 1, -2);
                    scene.add(object);
                },
                (xhr) => console.log((xhr.loaded / xhr.total) * 100 + '% loaded'),
                (error) => console.error('An error occurred while loading the OBJ:', error)
            );

            // Orbit Controls (for non-VR mode)
            controls = new OrbitControls(camera, renderer.domElement);
            camera.position.set(0, 1.5, 3);
            controls.update();

            // VR Controllers
            setupControllers();

            // Animation Loop
            renderer.setAnimationLoop(animate);

            // Window Resize Handling
            window.addEventListener('resize', onWindowResize);
        }

        function setupControllers() {
            // Create VR controllers
            controller1 = renderer.xr.getController(0);
            controller2 = renderer.xr.getController(1);
            scene.add(controller1);
            scene.add(controller2);

            // Add models to controllers
            const controllerModelFactory = new XRControllerModelFactory();
            controllerGrip1 = renderer.xr.getControllerGrip(0);
            controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
            scene.add(controllerGrip1);

            controllerGrip2 = renderer.xr.getControllerGrip(1);
            controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
            scene.add(controllerGrip2);

            // Add event listeners for grabbing objects
            controller1.addEventListener('selectstart', () => onGrabStart(controller1));
            controller1.addEventListener('selectend', () => onGrabEnd(controller1));
            controller2.addEventListener('selectstart', () => onGrabStart(controller2));
            controller2.addEventListener('selectend', () => onGrabEnd(controller2));
        }

        function onGrabStart(controller) {
            if (!object) return;

            // Check if controller is near the object
            const distance = controller.position.distanceTo(object.position);
            if (distance < 0.5) {
                selectedObject = object;
                selectedObject.attach(controller);
            }
        }

        function onGrabEnd(controller) {
            if (selectedObject) {
                scene.attach(selectedObject);  // Release object
                selectedObject = null;
            }
        }

        function animate() {
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>